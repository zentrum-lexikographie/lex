#!/usr/bin/env python

import logging
from pathlib import Path
import shutil
import clj

project_dir = (Path(__file__) / '..' / '..').resolve()

logging.basicConfig(format='%(asctime)s %(message)s', level=logging.INFO)


def clean_classes(name):
    classes_dir = project_dir / name / 'classes'
    if classes_dir.is_dir():
        shutil.rmtree(classes_dir.as_posix())
    classes_dir.mkdir()


def build_module(name, aliases):
    logging.info({'name': name, 'aliases': aliases})
    clj.run([':'.join(['-A'] + aliases)],
            cwd=(project_dir / name).as_posix(),
            check=True)


# Git tags --> version.edn
build_module('build', ['version'])

# RNC --> RNG/Schematron
build_module('build', ['schema'])

# Plugin for OxygenXML Editor and Server component
for module in ['client', 'server']:
    clean_classes(module)
    build_module(module, ['dev', 'prod', 'compile'])
    build_module(module, ['dev', 'prod', 'package'])
